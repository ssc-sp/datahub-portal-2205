@inject RegistrationService _registrationService
@inject IDbContextFactory<DatahubProjectDBContext> _dbFactory
@inject IJSRuntime _jsRuntime

<div class="registration-actions">
    @if (RegistrationRequest.Status == Datahub_Registration_Request.STATUS_REQUESTED)
    {
        if (!_isValid)
        {
            <AeButton @onclick="HandleEditAcronym">
                <i class="fas fa-edit"></i>
                Edit Acronym
            </AeButton>
        }
        else if (_isCreated)
        {
            <AeButton @onclick="HandleCreateUser">
                <i class="fas fa-plus"></i>
                Create User
            </AeButton>
        }
        else
        {
            <AeButton @onclick="HandleCreateProject">
                <i class="fas fa-plus"></i>
                Create Project
            </AeButton>
        }
    }
    else if (RegistrationRequest.Status == Datahub_Registration_Request.STATUS_APPROVED)
    {
        <AeTypography>
            <i class="fas fa-check"></i>
            Approved
        </AeTypography>
    }
    else
    {
        <AeTypography>Unrecognized: @RegistrationRequest.Status</AeTypography>
    }
</div>

@code {

    [Parameter]
    public Datahub_Registration_Request RegistrationRequest { get; set; }

    [Parameter]
    public EventCallback<Datahub_Registration_Request> OnRequestUpdated { get; set; }


    private bool _isValid = false;
    private bool _isCreated = false;

    protected override async Task OnParametersSetAsync()
    {
        await base.OnParametersSetAsync();
        await using var dbContext = await _dbFactory.CreateDbContextAsync();

        if (RegistrationRequest.Status == Datahub_Registration_Request.STATUS_REQUESTED)
        {
            _isValid = await _registrationService.IsValidRegistrationRequest(RegistrationRequest);
            _isCreated = await dbContext.Projects
                .AnyAsync(p => p.Project_Acronym_CD == RegistrationRequest.ProjectAcronym);
        }
    }
}